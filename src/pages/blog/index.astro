---
import { getCollection } from "astro:content";
import FormattedDate from "@/components/FormattedDate.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { SITE } from "@/config";
import { getSortedPosts, getUniqueCategories, getPostsByYear } from "@/utils/postAdapter";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const postsByYear = getPostsByYear(sortedPosts);
const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
const categories = getUniqueCategories(sortedPosts);
---

<BaseLayout title={`Blog | ${SITE.title}`} description={SITE.desc} lang="en" dir="ltr">
  <section>
    <h1 class="text-3xl font-bold mb-6">Blog</h1>

    <div class="filters mb-8 space-y-4" dir="ltr">
      <!-- Search -->
      <div class="search">
        <input
          id="postSearch"
          type="search"
          placeholder="Search posts..."
          autocomplete="off"
          class="w-full max-w-md rounded-lg border border-border bg-background px-4 py-2 focus:border-accent focus:outline-none"
        />
      </div>

      <!-- Category chips -->
      {categories.length > 0 && (
        <div class="chips flex flex-wrap gap-2" aria-label="Filter by category">
          <button
            class="chip is-active rounded-full border border-border px-3 py-1 text-sm transition-colors hover:border-accent"
            type="button"
            data-category=""
          >
            All
          </button>
          {categories.map((c) => (
            <button
              class="chip rounded-full border border-border px-3 py-1 text-sm transition-colors hover:border-accent"
              type="button"
              data-category={c}
              dir="auto"
            >
              {c}
            </button>
          ))}
        </div>
      )}

      <!-- Meta -->
      <div class="meta flex items-center gap-3 text-sm text-foreground/70">
        <span><span id="resultCount">{sortedPosts.length}</span> posts</span>
        <button id="clearFilters" class="text-accent hover:underline" type="button">
          Clear filters
        </button>
      </div>
    </div>

    <!-- Posts by year -->
    {years.map((year) => (
      <div class="year-group border-t border-border pt-4 mb-8" data-year={year}>
        <h2 class="year-title text-sm font-semibold uppercase tracking-wider text-foreground/60 mb-4">
          {year}
        </h2>
        <ul class="space-y-4">
          {postsByYear[year].map((post) => (
            <li
              dir="auto"
              data-category={post.data.category ?? ""}
              data-tags={post.data.tags?.join(",") ?? ""}
              data-search={`${post.data.title ?? ""} ${post.data.description ?? ""}`.toLowerCase()}
              data-url={`/blog/${encodeURIComponent(post.id)}/`}
              class="flex items-start gap-4 py-2 transition-opacity"
            >
              <time
                datetime={post.data.pubDate.toISOString()}
                class="shrink-0 text-sm text-foreground/60 w-24"
              >
                {post.data.pubDate.toLocaleDateString("en-US", {
                  month: "short",
                  day: "2-digit",
                })}
              </time>
              <div class="flex-1 min-w-0">
                <a
                  href={`/blog/${encodeURIComponent(post.id)}/`}
                  class="font-medium hover:text-accent transition-colors"
                  dir="auto"
                >
                  {post.data.title}
                </a>
                {post.data.category && (
                  <span class="ml-2 text-xs text-foreground/50" dir="auto">
                    [{post.data.category}]
                  </span>
                )}
                {post.data.description && (
                  <p class="mt-1 text-sm text-foreground/70 line-clamp-2" dir="auto">
                    {post.data.description}
                  </p>
                )}
              </div>
            </li>
          ))}
        </ul>
      </div>
    ))}
  </section>
</BaseLayout>

<style>
  .chip.is-active {
    border-color: var(--accent);
    color: var(--accent);
  }
</style>

<script>
  const searchEl = document.getElementById("postSearch") as HTMLInputElement | null;
  const chips = Array.from(document.querySelectorAll(".chip"));
  const clearBtn = document.getElementById("clearFilters");
  const countEl = document.getElementById("resultCount");
  const items = Array.from(document.querySelectorAll(".year-group li"));
  const yearGroups = Array.from(document.querySelectorAll(".year-group"));
  let activeCategory = "";
  let pagefindInstance: any = null;
  let searchResultUrls: Set<string> | null = null;

  // Check URL for initial category filter
  const urlParams = new URLSearchParams(window.location.search);
  const initialCategory = urlParams.get("category") || "";
  if (initialCategory) {
    activeCategory = initialCategory;
  }

  async function initPagefind() {
    if (pagefindInstance) return pagefindInstance;
    try {
      const pagefindPath = `/pagefind/pagefind.js`;
      pagefindInstance = await import(/* @vite-ignore */ pagefindPath);
      await pagefindInstance.init();
    } catch (e) {
      console.warn("Pagefind not available (dev mode?):", e);
      pagefindInstance = null;
    }
    return pagefindInstance;
  }

  function applyVisibility(): void {
    let visible = 0;

    for (const li of items) {
      const cat = li.getAttribute("data-category") || "";
      const tags = li.getAttribute("data-tags") || "";
      const url = li.getAttribute("data-url") || "";
      const hay = li.getAttribute("data-search") || "";

      const matchCat = !activeCategory || cat === activeCategory || tags.includes(activeCategory);

      let matchQ = true;
      if (searchResultUrls !== null) {
        // Normalize data-url to match pagefind's decoded URLs
        const decodedUrl = decodeURIComponent(url);
        matchQ = searchResultUrls.has(decodedUrl);
      } else {
        const q = (searchEl?.value || "").toLowerCase().replace(/\s+/g, " ").trim();
        matchQ = !q || hay.includes(q);
      }

      const show = matchCat && matchQ;
      (li as HTMLElement).style.display = show ? "" : "none";
      if (show) visible += 1;
    }

    if (countEl) countEl.textContent = String(visible);

    for (const g of yearGroups) {
      const anyVisible = (g as HTMLElement).querySelectorAll('li:not([style*="display: none"])').length > 0;
      (g as HTMLElement).style.display = anyVisible ? "" : "none";
    }
  }

  let searchTimeout: ReturnType<typeof setTimeout> | null = null;

  async function onSearchInput(): Promise<void> {
    const q = (searchEl?.value || "").trim();

    if (!q) {
      searchResultUrls = null;
      applyVisibility();
      return;
    }

    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
      const pf = await initPagefind();
      if (!pf) {
        searchResultUrls = null;
        applyVisibility();
        return;
      }

      const search = await pf.search(q);
      const results = await Promise.all(search.results.map((r: any) => r.data()));
      searchResultUrls = new Set(
        results.map((r: any) => {
          // Normalize: decode URI, strip index.html, ensure trailing slash
          let url = decodeURIComponent(new URL(r.url, window.location.origin).pathname);
          url = url.replace(/\/index\.html$/, "/");
          if (!url.endsWith("/")) url += "/";
          return url;
        })
      );

      applyVisibility();
    }, 300);
  }

  function setActiveChip(): void {
    for (const btn of chips) {
      const isActive = (btn as HTMLElement).dataset.category === activeCategory;
      btn.classList.toggle("is-active", isActive);
    }
  }

  // Chip clicks
  for (const btn of chips) {
    btn.addEventListener("click", () => {
      activeCategory = (btn as HTMLElement).dataset.category || "";
      setActiveChip();
      applyVisibility();
      const url = new URL(window.location.href);
      if (activeCategory) {
        url.searchParams.set("category", activeCategory);
      } else {
        url.searchParams.delete("category");
      }
      window.history.replaceState({}, "", url.toString());
    });
  }

  // Search typing
  if (searchEl) {
    searchEl.addEventListener("input", onSearchInput);
    searchEl.addEventListener("focus", () => initPagefind(), { once: true });
  }

  // Clear
  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      activeCategory = "";
      searchResultUrls = null;
      if (searchEl) searchEl.value = "";
      setActiveChip();
      applyVisibility();
      searchEl?.focus?.();
      const url = new URL(window.location.href);
      url.searchParams.delete("category");
      window.history.replaceState({}, "", url.toString());
    });
  }

  // Initial state
  setActiveChip();
  applyVisibility();
</script>
